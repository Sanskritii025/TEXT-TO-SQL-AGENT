# Sales Policy - B2B SaaS (Technically Explicit for RAG AI Agent)

Version: 1.0
Effective Date: 2026-01-12
Database: PostgreSQL

---

## Schema Reference

Primary Tables:
- `opportunities` - Deal/opportunity records with amount, stage, close_date
- `accounts` - Customer accounts with region assignment
- `invoices` - Invoice records with payment_status, due_date, balance_due
- `quotes` - Quote documents with quote_amount and status
- `territories` - Geographic sales divisions with manager_name
- `sales_reps` - Sales representative records with territory assignment
- `customers` - Customer contact information with country
- `sales_orders` - Order records linking opportunities to invoices
- `approval_requests` - Discount/exception approval workflow tracking

---

## High Value Deal Definition

A deal is classified as a High Value Deal if ANY of the following conditions are met:

Rule: A deal is High Value if the Annual Contract Value (ACV) is greater than or equal to $100,000.

[SQL Mapping]: Use table `opportunities`, column `amount`. The policy term "ACV" maps to `opportunities.amount` which represents the estimated annual deal value.
Condition: `opportunities.amount >= 100000`

---

Rule: A deal is High Value if the Total Contract Value (TCV) is greater than or equal to $250,000.

[SQL Mapping]: TCV requires calculation from opportunities and contract duration. Use table `opportunities`, column `amount`, and extract contract years from `opportunities.metadata->>'contract_years'` if stored, or join with `quotes` table.
Condition (if TCV stored in metadata): `(opportunities.metadata->>'tcv')::numeric >= 250000`
Condition (if calculated): `opportunities.amount * COALESCE((opportunities.metadata->>'contract_years')::int, 1) >= 250000`

---

Rule: A deal is High Value if the Seat Count is greater than or equal to 500 users.

[SQL Mapping]: Seat count is stored in `opportunities.metadata` as a JSON field. Use table `opportunities`, access via `opportunities.metadata->>'seat_count'`.
Condition: `(opportunities.metadata->>'seat_count')::int >= 500`

---

Rule: A deal is High Value if the contract commitment is 3 years or longer, regardless of the ACV amount.

[SQL Mapping]: Contract duration is stored in `opportunities.metadata` as a JSON field. Use table `opportunities`, access via `opportunities.metadata->>'contract_years'`.
Condition: `(opportunities.metadata->>'contract_years')::int >= 3`

---

Summary Formula (Pseudo-SQL):
```sql
SELECT opportunity_id, amount
FROM opportunities
WHERE amount >= 100000
   OR (metadata->>'tcv')::numeric >= 250000
   OR (metadata->>'seat_count')::int >= 500
   OR (metadata->>'contract_years')::int >= 3;
```

---

## Discount Approval Matrix

Rule: For discounts between 0% and 10%, the required approver is the Account Executive. The maximum response SLA is immediate approval.

[SQL Mapping]: Discount percentage is calculated by comparing `quotes.quote_amount` to `opportunities.amount`. Use tables `quotes` JOIN `opportunities` ON `quotes.opportunity_id = opportunities.opportunity_id`. Approval tracking uses table `approval_requests`, column `approver_role`.
Condition: `((opportunities.amount - quotes.quote_amount) / opportunities.amount * 100) BETWEEN 0 AND 10`
Approver Logic: `approval_requests.approver_role = 'Account Executive'`

---

Rule: For discounts between 11% and 20%, the required approver is the Sales Manager. The maximum response SLA is 4 hours.

[SQL Mapping]: Use tables `quotes` JOIN `opportunities`. Track in `approval_requests` with `approver_role`.
Condition: `((opportunities.amount - quotes.quote_amount) / opportunities.amount * 100) BETWEEN 11 AND 20`
Approver Logic: `approval_requests.approver_role = 'Sales Manager'`

---

Rule: For discounts between 21% and 30%, the required approver is the Regional Director. The maximum response SLA is 24 hours.

[SQL Mapping]: Use tables `quotes` JOIN `opportunities`. Track in `approval_requests` with `approver_role`.
Condition: `((opportunities.amount - quotes.quote_amount) / opportunities.amount * 100) BETWEEN 21 AND 30`
Approver Logic: `approval_requests.approver_role = 'Regional Director'`

---

Rule: For discounts between 31% and 40%, the required approver is the VP of Sales. The maximum response SLA is 48 hours.

[SQL Mapping]: Use tables `quotes` JOIN `opportunities`. Track in `approval_requests` with `approver_role`.
Condition: `((opportunities.amount - quotes.quote_amount) / opportunities.amount * 100) BETWEEN 31 AND 40`
Approver Logic: `approval_requests.approver_role = 'VP of Sales'`

---

Rule: For discounts between 41% and 50%, the required approver is the CRO (Chief Revenue Officer). The maximum response SLA is 72 hours.

[SQL Mapping]: Use tables `quotes` JOIN `opportunities`. Track in `approval_requests` with `approver_role`.
Condition: `((opportunities.amount - quotes.quote_amount) / opportunities.amount * 100) BETWEEN 41 AND 50`
Approver Logic: `approval_requests.approver_role = 'CRO'`

---

Rule: For discounts greater than 50%, dual approval is required from both the CEO and CFO. The maximum response SLA is 5 business days.

[SQL Mapping]: Use tables `quotes` JOIN `opportunities`. Requires TWO records in `approval_requests` with `approver_role` IN ('CEO', 'CFO') and both having `status = 'Approved'`.
Condition: `((opportunities.amount - quotes.quote_amount) / opportunities.amount * 100) > 50`
Approver Logic (Pseudo-SQL):
```sql
SELECT quote_id FROM approval_requests
WHERE quote_id = :quote_id
  AND approver_role IN ('CEO', 'CFO')
  AND status = 'Approved'
GROUP BY quote_id
HAVING COUNT(DISTINCT approver_role) = 2;
```

---

### Discount Edge Cases and Exceptions

Rule: Discount stacking is prohibited. Only one discount type may be applied per deal.

[SQL Mapping]: Validate by counting distinct discount types in `quotes.metadata->>'discount_type'` per opportunity. Use table `quotes`.
Validation Query:
```sql
SELECT opportunity_id, COUNT(DISTINCT metadata->>'discount_type') as discount_types
FROM quotes
WHERE opportunity_id = :opp_id
GROUP BY opportunity_id
HAVING COUNT(DISTINCT metadata->>'discount_type') > 1;
-- If result exists, policy violation detected
```

---

Rule: Multi-year prepay discounts are allowed up to a maximum of 5% per year and do NOT require escalation through the approval matrix.

[SQL Mapping]: Check `quotes.metadata->>'discount_type' = 'multi_year_prepay'` and validate discount does not exceed `5 * contract_years`. Use tables `quotes` JOIN `opportunities`.
Condition: `quotes.metadata->>'discount_type' = 'multi_year_prepay'`
Validation: `((opportunities.amount - quotes.quote_amount) / opportunities.amount * 100) <= (5 * (opportunities.metadata->>'contract_years')::int)`

---

Rule: Non-profit and educational institution (EDU) discounts are capped at a maximum of 25% and always require Regional Director approval, regardless of the discount percentage.

[SQL Mapping]: Check account type via `accounts.account_type` IN ('Non-Profit', 'EDU', 'Education'). Maximum discount = 25%. Use tables `quotes` JOIN `opportunities` JOIN `accounts` ON `opportunities.account_id = accounts.account_id`.
Condition: `accounts.account_type IN ('Non-Profit', 'EDU', 'Education')`
Validation: `((opportunities.amount - quotes.quote_amount) / opportunities.amount * 100) <= 25`
Approver Logic: `approval_requests.approver_role = 'Regional Director'` (always required)

---

## Churn Definition

A customer is marked as CHURNED when both of the following conditions are true: the invoice status is "Unpaid" AND the invoice is more than 90 days overdue.

[SQL Mapping]: Use table `invoices`, columns `payment_status` and `due_date`. The policy term "Unpaid" maps to `invoices.payment_status = 'Overdue'` (as per invoice_status ENUM: 'Pending', 'Paid', 'Overdue', 'Cancelled'). Days overdue calculated as `CURRENT_DATE - invoices.due_date`.
Condition: `invoices.payment_status = 'Overdue' AND (CURRENT_DATE - invoices.due_date) > 90`

---

### Churn Risk Classification

Rule: If an invoice is unpaid and between 1 and 30 days overdue, the customer status is AT_RISK. The required action is to send an automated reminder and initiate Customer Success Manager (CSM) outreach.

[SQL Mapping]: Use table `invoices`, columns `payment_status`, `due_date`. Join path to customer: `invoices` -> `sales_orders` -> `opportunities` -> `accounts` -> `customers`.
Condition: `invoices.payment_status IN ('Pending', 'Overdue') AND (CURRENT_DATE - invoices.due_date) BETWEEN 1 AND 30`
Full Query (Pseudo-SQL):
```sql
SELECT c.customer_id, c.name, 'AT_RISK' as churn_status
FROM invoices i
JOIN sales_orders so ON i.sales_order_id = so.sales_order_id
JOIN opportunities o ON so.opportunity_id = o.opportunity_id
JOIN accounts a ON o.account_id = a.account_id
JOIN customers c ON a.primary_customer_id = c.customer_id
WHERE i.payment_status IN ('Pending', 'Overdue')
  AND (CURRENT_DATE - i.due_date) BETWEEN 1 AND 30;
```

---

Rule: If an invoice is unpaid and between 31 and 60 days overdue, the customer status is HIGH_RISK. The required action is CSM escalation and Director review.

[SQL Mapping]: Use table `invoices`, columns `payment_status`, `due_date`. Same join path as above.
Condition: `invoices.payment_status IN ('Pending', 'Overdue') AND (CURRENT_DATE - invoices.due_date) BETWEEN 31 AND 60`
Churn Status: `'HIGH_RISK'`

---

Rule: If an invoice is unpaid and between 61 and 90 days overdue, the customer status is CRITICAL. The required action is executive intervention.

[SQL Mapping]: Use table `invoices`, columns `payment_status`, `due_date`. Same join path as above.
Condition: `invoices.payment_status IN ('Pending', 'Overdue') AND (CURRENT_DATE - invoices.due_date) BETWEEN 61 AND 90`
Churn Status: `'CRITICAL'`

---

Rule: If an invoice is unpaid and more than 90 days overdue, the customer status is CHURNED. The required action is to suspend the account and mark it as lost.

[SQL Mapping]: Use table `invoices`, columns `payment_status`, `due_date`. Same join path as above.
Condition: `invoices.payment_status IN ('Pending', 'Overdue') AND (CURRENT_DATE - invoices.due_date) > 90`
Churn Status: `'CHURNED'`

---

Rule: If all invoices are paid or current, the customer status is CURRENT.

[SQL Mapping]: Use table `invoices`, column `payment_status`. Verify no overdue invoices exist for the customer.
Condition: All invoices for customer have `invoices.payment_status = 'Paid'` OR `(CURRENT_DATE - invoices.due_date) <= 0`
Churn Status: `'CURRENT'`

---

Complete Churn Classification Query (Pseudo-SQL):
```sql
SELECT 
  c.customer_id,
  c.name,
  CASE
    WHEN MAX(CURRENT_DATE - i.due_date) > 90 AND i.payment_status != 'Paid' THEN 'CHURNED'
    WHEN MAX(CURRENT_DATE - i.due_date) BETWEEN 61 AND 90 AND i.payment_status != 'Paid' THEN 'CRITICAL'
    WHEN MAX(CURRENT_DATE - i.due_date) BETWEEN 31 AND 60 AND i.payment_status != 'Paid' THEN 'HIGH_RISK'
    WHEN MAX(CURRENT_DATE - i.due_date) BETWEEN 1 AND 30 AND i.payment_status != 'Paid' THEN 'AT_RISK'
    ELSE 'CURRENT'
  END as churn_status
FROM customers c
JOIN accounts a ON c.customer_id = a.primary_customer_id
JOIN opportunities o ON a.account_id = o.account_id
JOIN sales_orders so ON o.opportunity_id = so.opportunity_id
JOIN invoices i ON so.sales_order_id = i.sales_order_id
GROUP BY c.customer_id, c.name, i.payment_status;
```

---

## Territory Rules

Rule: Territory assignment for a customer is determined by the customer's billing address country.

[SQL Mapping]: Use table `customers`, column `country` to determine territory. Map country to region via lookup (requires region mapping table or logic). Use table `territories`, column `region` (ENUM: 'North', 'South', 'East', 'West', 'Central', 'International').
Join Path: `customers.country` -> (country-to-region mapping) -> `territories.region`

---

Rule: The territory manager can be found by joining sales_reps to territories.

[SQL Mapping]: Use tables `territories` and `sales_reps`. Join on `sales_reps.territory_id = territories.territory_id`. Manager name is in `territories.manager_name`.
Query:
```sql
SELECT t.territory_id, t.region, t.manager_name, sr.name as sales_rep_name
FROM territories t
LEFT JOIN sales_reps sr ON t.territory_id = sr.territory_id
WHERE sr.is_active = true;
```

---

Rule: Named accounts take precedence over standard territory rules. Always check the named_accounts table first before applying territory assignment.

[SQL Mapping]: Named accounts would be checked via `accounts.metadata->>'named_account'` or a dedicated named_accounts lookup table (if exists). Use table `accounts`.
Condition: Check `accounts.metadata->>'named_account' IS NOT NULL` or `accounts.metadata->>'named_account_territory_id' IS NOT NULL` before applying standard territory rules.

---

Rule: Cross-territory deals require written approval from both Regional Directors involved in the transaction.

[SQL Mapping]: Detect cross-territory by comparing customer territory vs. assigned rep territory. Use tables `accounts`, `sales_reps`, `territories`. Track approval in `approval_requests` with `trigger_reason = 'Cross-Territory Deal'`.
Detection Query:
```sql
SELECT o.opportunity_id
FROM opportunities o
JOIN accounts a ON o.account_id = a.account_id
JOIN sales_reps sr ON sr.territory_id != (
  SELECT territory_id FROM territories WHERE region = a.region
)
WHERE sr.is_active = true;
-- If match exists, cross-territory approval required
```

---

### Territory-Region Mapping Reference

[SQL Mapping]: Use table `territories`, columns `territory_id`, `region` (ENUM), `manager_name`. Use table `accounts`, column `region` for account assignment.

Region ENUM Values: 'North', 'South', 'East', 'West', 'Central', 'International'

Sample Query:
```sql
SELECT territory_id, region, manager_name
FROM territories
WHERE region = 'North';
```

---

## Pipeline Stages and Forecast Inclusion

### Stage Definitions

[SQL Mapping]: Use table `opportunities`, column `stage` (ENUM type `opp_stage`). Valid values: 'Prospecting', 'Qualification', 'Needs Analysis', 'Proposal', 'Negotiation', 'Closed Won', 'Closed Lost'.

Note: Policy stages S1-S8 map to database ENUM as follows:
- S1 (Prospecting) -> `stage = 'Prospecting'`
- S2 (Discovery) -> Not in ENUM; closest is 'Qualification' or 'Needs Analysis'
- S3 (Qualification) -> `stage = 'Qualification'`
- S4 (Solution Proposal) -> `stage = 'Proposal'`
- S5 (Negotiation) -> `stage = 'Negotiation'`
- S6 (Contract Sent) -> Not in ENUM; track via `quotes.status = 'Sent'`
- S7 (Closed Won) -> `stage = 'Closed Won'`
- S8 (Closed Lost) -> `stage = 'Closed Lost'`

---

Rule: Stage S1 (Prospecting) has a win probability of 10%. Deals in this stage do NOT count towards the forecast. The forecast category is Pipeline.

[SQL Mapping]: Use table `opportunities`, column `stage`, column `win_probability`.
Condition: `opportunities.stage = 'Prospecting'`
Default Probability: `opportunities.win_probability = 10` (or 10 if NULL)
Forecast Inclusion: `FALSE`

---

Rule: Stage S3 (Qualification) has a win probability of 30%. Deals in this stage do NOT count towards the forecast. The forecast category is Pipeline.

[SQL Mapping]: Use table `opportunities`, column `stage`.
Condition: `opportunities.stage = 'Qualification'`
Default Probability: 30
Forecast Inclusion: `FALSE`

---

Rule: Stage S4 (Solution Proposal) has a win probability of 50%. Deals in this stage DO count towards the forecast. The forecast category is Best Case.

[SQL Mapping]: Use table `opportunities`, column `stage`.
Condition: `opportunities.stage = 'Proposal'`
Default Probability: 50
Forecast Inclusion: `TRUE`
Forecast Category: `'Best Case'`

---

Rule: Stage S5 (Negotiation) has a win probability of 70%. Deals in this stage DO count towards the forecast. The forecast category is Commit.

[SQL Mapping]: Use table `opportunities`, column `stage`.
Condition: `opportunities.stage = 'Negotiation'`
Default Probability: 70
Forecast Inclusion: `TRUE`
Forecast Category: `'Commit'`

---

Rule: Stage S6 (Contract Sent) has a win probability of 85%. Deals in this stage DO count towards the forecast. The forecast category is Commit.

[SQL Mapping]: Since 'Contract Sent' is not a stage ENUM value, detect via `quotes.status = 'Sent'` with stage still at 'Negotiation'. Use tables `opportunities` JOIN `quotes`.
Condition: `opportunities.stage = 'Negotiation' AND EXISTS (SELECT 1 FROM quotes WHERE quotes.opportunity_id = opportunities.opportunity_id AND quotes.status = 'Sent')`
Default Probability: 85
Forecast Inclusion: `TRUE`
Forecast Category: `'Commit'`

---

Rule: Stage S7 (Closed Won) has a win probability of 100%. Deals in this stage DO count towards the forecast. The forecast category is Closed.

[SQL Mapping]: Use table `opportunities`, column `stage`.
Condition: `opportunities.stage = 'Closed Won'`
Default Probability: 100
Forecast Inclusion: `TRUE`
Forecast Category: `'Closed'`

---

Rule: Stage S8 (Closed Lost) has a win probability of 0%. Deals in this stage do NOT count towards the forecast. The forecast category is Lost.

[SQL Mapping]: Use table `opportunities`, column `stage`.
Condition: `opportunities.stage = 'Closed Lost'`
Default Probability: 0
Forecast Inclusion: `FALSE`
Forecast Category: `'Lost'`

---

### Forecast Calculation Rules

Rule: The Weighted Forecast is calculated by summing the product of Deal Value multiplied by Stage Probability for all deals where the stage counts towards the forecast (stages S4, S5, S6, and S7).

[SQL Mapping]: Use table `opportunities`, columns `amount`, `stage`, `win_probability`.
Query:
```sql
SELECT SUM(amount * COALESCE(win_probability, 
  CASE stage
    WHEN 'Proposal' THEN 50
    WHEN 'Negotiation' THEN 70
    WHEN 'Closed Won' THEN 100
    ELSE 0
  END) / 100.0) as weighted_forecast
FROM opportunities
WHERE stage IN ('Proposal', 'Negotiation', 'Closed Won');
```

---

Rule: The Commit Forecast is calculated by summing the Deal Value for all deals in stages S5 (Negotiation) and S6 (Contract Sent).

[SQL Mapping]: Use table `opportunities`, columns `amount`, `stage`. Optionally join `quotes` for Contract Sent detection.
Query:
```sql
SELECT SUM(amount) as commit_forecast
FROM opportunities
WHERE stage = 'Negotiation';
```

---

Rule: The Best Case Forecast is calculated by summing the Deal Value for all deals in stages S4 (Solution Proposal), S5 (Negotiation), and S6 (Contract Sent).

[SQL Mapping]: Use table `opportunities`, columns `amount`, `stage`.
Query:
```sql
SELECT SUM(amount) as best_case_forecast
FROM opportunities
WHERE stage IN ('Proposal', 'Negotiation');
```

---

### Pipeline Stage Rules and Exceptions

Rule: Deals in stage S4 (Solution Proposal) or later require a validated close date that falls within the current forecast period.

[SQL Mapping]: Use table `opportunities`, columns `stage`, `close_date`. Validate `close_date` is within current quarter/period.
Condition: `opportunities.stage IN ('Proposal', 'Negotiation', 'Closed Won') AND opportunities.close_date IS NOT NULL`
Validation: `opportunities.close_date BETWEEN :period_start AND :period_end`

---

Rule: Deals in stage S5 (Negotiation) or later require documented stakeholder approval from both the Champion and the Economic Buyer.

[SQL Mapping]: Stakeholder approvals tracked in `opportunities.metadata` or in `documents` table linked via `related_opportunity_id`.
Condition: `opportunities.stage IN ('Negotiation', 'Closed Won')`
Validation: Check `opportunities.metadata->>'champion_approved' = 'true' AND opportunities.metadata->>'economic_buyer_approved' = 'true'`

---

Rule: Deals that have been stalled for more than 30 days at any stage are automatically flagged for pipeline review.

[SQL Mapping]: Requires stage change tracking. If last update stored in `opportunities.metadata->>'last_stage_change'` or derived from `agent_audit_logs`.
Condition: `CURRENT_DATE - (opportunities.metadata->>'last_stage_change')::date > 30`
Alternative (using audit log):
```sql
SELECT o.opportunity_id
FROM opportunities o
LEFT JOIN agent_audit_logs log ON log.related_entity_id = o.opportunity_id
  AND log.agent_action = 'stage_change'
WHERE CURRENT_DATE - COALESCE(log.timestamp::date, o.created_at::date) > 30;
```

---

Rule: Deals that have been pushed (close date moved) more than 2 times are automatically removed from the Commit forecast and reclassified to Best Case.

[SQL Mapping]: Track close date changes in `opportunities.metadata->>'close_date_push_count'` or count via `agent_audit_logs`.
Condition: `(opportunities.metadata->>'close_date_push_count')::int > 2`
Effect: Exclude from Commit forecast, include only in Best Case.
Query:
```sql
SELECT opportunity_id, amount
FROM opportunities
WHERE stage = 'Negotiation'
  AND (metadata->>'close_date_push_count')::int > 2;
-- These deals should be in Best Case, not Commit
```

---

## Quick Reference: Table Relationships

```
customers (customer_id)
    └── accounts (primary_customer_id -> customer_id)
            └── opportunities (account_id -> account_id)
                    ├── quotes (opportunity_id -> opportunity_id)
                    │       └── approval_requests (quote_id -> quote_id)
                    ├── sales_orders (opportunity_id -> opportunity_id)
                    │       └── invoices (sales_order_id -> sales_order_id)
                    └── documents (related_opportunity_id -> opportunity_id)

territories (territory_id)
    └── sales_reps (territory_id -> territory_id)
```

---

## Quick Reference: Key Column Mappings

| Policy Term | Table | Column | Notes |
|-------------|-------|--------|-------|
| ACV / Deal Value | opportunities | amount | Estimated annual value |
| TCV | opportunities | metadata->>'tcv' | Total contract value |
| Seat Count | opportunities | metadata->>'seat_count' | User count |
| Contract Years | opportunities | metadata->>'contract_years' | Duration |
| Deal Stage | opportunities | stage | ENUM: opp_stage |
| Win Probability | opportunities | win_probability | 0-100 integer |
| Close Date | opportunities | close_date | DATE type |
| Quote Amount | quotes | quote_amount | Quoted price |
| Quote Status | quotes | status | ENUM: quote_status |
| Invoice Status | invoices | payment_status | ENUM: invoice_status |
| Invoice Due Date | invoices | due_date | DATE type |
| Days Overdue | invoices | (CURRENT_DATE - due_date) | Calculated |
| Territory Region | territories | region | ENUM: region_type |
| Territory Manager | territories | manager_name | VARCHAR(100) |
| Account Region | accounts | region | ENUM: region_type |
| Customer Country | customers | country | VARCHAR(100) |
| Rep Active Status | sales_reps | is_active | BOOLEAN |
| Approval Status | approval_requests | status | VARCHAR(20) |
| Approver Role | approval_requests | approver_role | VARCHAR(50) |
